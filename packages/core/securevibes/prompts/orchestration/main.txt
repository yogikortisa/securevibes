Perform a complete security analysis of this codebase.

EXECUTION MODE CHECK:
- Check if environment variable RUN_ONLY_SUBAGENT is set
- If RUN_ONLY_SUBAGENT is set, run ONLY that sub-agent and skip all others
- Check if environment variable SKIP_SUBAGENTS is set  
- If SKIP_SUBAGENTS is set (comma-separated list), skip those sub-agents
- Otherwise, execute all phases sequentially

Execute these phases SEQUENTIALLY, ONE AT A TIME:

PHASE 1: ASSESSMENT
- Skip if: SKIP_SUBAGENTS contains "assessment" OR (RUN_ONLY_SUBAGENT is set AND != "assessment")
- Announce: "Starting Phase 1: Assessment"
- Use the 'assessment' agent to analyze architecture
- Creates .securevibes/SECURITY.md
- Report: "Assessment complete" when done
- WAIT for completion before proceeding

PHASE 2: THREAT MODELING
- Skip if: SKIP_SUBAGENTS contains "threat-modeling" OR (RUN_ONLY_SUBAGENT is set AND != "threat-modeling")
- Announce: "Starting Phase 2: Threat Modeling"
- Use the 'threat-modeling' agent to search for threat patterns using STRIDE
- Reads .securevibes/SECURITY.md
- Creates .securevibes/THREAT_MODEL.json
- Report: "Threat modeling complete" when done
- WAIT for completion before proceeding

PHASE 3: CODE REVIEW
- Skip if: SKIP_SUBAGENTS contains "code-review" OR (RUN_ONLY_SUBAGENT is set AND != "code-review")
- Announce: "Starting Phase 3: Code Review"
- Use the 'code-review' agent to validate threats with evidence
- Reads .securevibes/THREAT_MODEL.json
- Creates .securevibes/VULNERABILITIES.json
- Report: "Code review complete" when done
- WAIT for completion before proceeding

PHASE 4: REPORT GENERATION
- Skip if: SKIP_SUBAGENTS contains "report-generator" OR (RUN_ONLY_SUBAGENT is set AND != "report-generator")
- Announce: "Starting Phase 4: Report Generation"
- Use the 'report-generator' agent for final report
- Reads SECURITY.md, THREAT_MODEL.json, VULNERABILITIES.json
- Creates .securevibes/scan_results.json with ALL vulnerabilities
- Report: "Report generation complete" when done
- WAIT for completion before proceeding

PHASE 5: DAST VALIDATION (CONDITIONAL)
- Skip if: DAST_ENABLED != "true" OR SKIP_SUBAGENTS contains "dast" OR (RUN_ONLY_SUBAGENT is set AND != "dast")
- Check environment variable DAST_ENABLED
- If DAST_ENABLED != "true", SKIP this phase entirely
- If DAST_ENABLED == "true":
  - Announce: "Starting Phase 5: DAST Validation"
  - Read the full DAST prompt from .claude/prompts/dast.txt or use the prompt below
  - Pass the COMPLETE DAST prompt (not a summary) to the Task tool
  - Reads .securevibes/VULNERABILITIES.json
  - Creates .securevibes/DAST_VALIDATION.json
  - Report: "DAST validation complete" when done

DAST TARGET URL: {target_url}
Pass this exact URL to the DAST validation agent. The agent MUST use this URL for testing.

DAST TEST ACCOUNTS (IMPORTANT FOR AUTHENTICATED TESTING):
- Check if .securevibes/DAST_TEST_ACCOUNTS.json exists
- If it exists, read it and pass the credentials to the DAST agent
- The DAST agent MUST:
  1. Read SECURITY.md to understand the auth mechanism (session-based, JWT, API key, OAuth)
  2. Authenticate using the provided credentials to get a session/token
  3. Use the session/token for ALL vulnerability validation tests that require authentication
- If accounts file doesn't exist, test only public endpoints

DAST OUTPUT SCHEMA (CRITICAL - SCANNER VALIDATES THIS):
The DAST_VALIDATION.json file MUST have EXACTLY this structure:
{
  "dast_scan_metadata": {
    "target_url": "{target_url}",
    "scan_timestamp": "ISO8601 with timezone",
    "total_vulnerabilities_tested": integer,
    "validated": integer,
    "false_positives": integer,
    "unvalidated": integer,
    "scan_duration_seconds": float,
    "target_reachable": boolean (true/false, NOT a string),
    "skills_available": ["string"],
    "test_accounts_available": boolean
  },
  "validations": [
    {
      "vulnerability_id": "T001",
      "title": "string",
      "cwe_id": "CWE-XXX",
      "severity": "critical|high|medium|low",
      "validation_status": "VALIDATED|FALSE_POSITIVE|UNVALIDATED",
      "reason": "string or null",
      "tested_at": "ISO8601 with timezone",
      "test_steps": ["string"] or null,
      "evidence": {...} or null,
      "exploitability_score": float or null,
      "notes": "string or null"
    }
  ]
}

DO NOT USE: "metadata", "executive_summary", "critical_vulnerabilities_validated", or custom keys.
DO NOT USE: "NOT_APPLICABLE_FOR_DAST" or other custom status values.
MUST USE: "vulnerability_id" copied EXACTLY from VULNERABILITIES.json "threat_id" field (e.g., "T001", "T002").
MUST USE: "tested_at" in ISO8601 format and valid validation_status (VALIDATED/FALSE_POSITIVE/UNVALIDATED).

CRITICAL RULES:
- Execute agents ONE AT A TIME in strict sequential order
- Explicitly announce each phase before starting
- WAIT for each phase to complete before starting the next
- VERIFY the required artifact exists after each phase. If missing, STOP IMMEDIATELY.
- Each agent uses ONLY its assigned tools
- Phase 5 is OPTIONAL - only run if DAST_ENABLED=true

Keep responses brief - focus on announcing phases, invoking agents, and reporting completion.
